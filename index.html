<!DOCTYPE html>
<html>
  <head>
  	<title>dtd-diagram</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="dist/dtd-diagram.min.css">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.0.2/es6-promise.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="http://chrismaloney.org/d3-flextree/dist/d3-flextree.min.js"></script>
    <script src="dist/dtd-diagram.js"></script>
    <script>
      // Use the fragment, if present, to identify the root element, state, etc.
      var frag;
      function parse_frag() {
        var f = window.location.hash.substr(1) || "";
        var segs = f.split("!");
        frag = {
          root: segs[0] || null,
          state: segs[1] || null,
        }
      }

      var diagram;
      function make_diagram() {
        parse_frag();
        diagram = new DtdDiagram({
          root_element: frag.root,
          initial_state: frag.state,
          event_handler: function(action, n) {
            var state = diagram.last_state = {
              action: action,
              node_id: n.id,
            };
            window.history.pushState(
              state,
              null, 
              "#" + diagram.root.name + "!" + diagram.state()
            );
          },
        });
      };

      make_diagram();

      window.onpopstate = function(evt) {
        console.log("popstate: %o", evt.state);
        var state = diagram.last_state || null;
        if (!state || !state.action || state.action == "rebase") {
          d3.select('#dtd-diagram').html("");
          make_diagram();
        }
        else {
          parse_frag();
          diagram.set_state(frag.state);
          diagram.update(state.node_id);
        }
        diagram.last_state = evt.state;
      };
    </script>
  </head>
  <body>
    <h1>dtd-diagram</h1>
    <div id='dtd-diagram' 
         data-options='{
             "dtd_json_file": "test/JATS-journalpublishing1.json",
             "tag_doc_base": "http://jatspan.org/niso/publishing-1.1d3/#p="
         }'></div>

    <a href="https://github.com/Klortho/dtd-diagram"><img 
      style="position: absolute; top: 0; right: 0; border: 0;" 
      src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" 
      alt="Fork me on GitHub" 
      data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
  </body>
</html>
