"undefined"!=typeof d3&&!function(){var t=window.DtdDiagram=function(n){var r=this;t.diagrams_array.push(r),r.constructor_opts=n||{},e.then(function(){return r.initialize()}).then(function(){return r.update()})["catch"](function(t){console.error(t.stack)})};t.diagrams_array=[],t.diagrams_hash={},t.auto_start=!0;var e=t.document_ready=new Promise(function(t){document.addEventListener("DOMContentLoaded",t)});e.then(function(){t.auto_start&&0==t.diagrams_array.length&&new t});var n=20;t.default_options={dtd_json_file:"dtd.json",orig_root_name:null,current_root_addr:"0",ec_state:"S",src_node_addr:"",tag_doc_base:"doc/#p=",tag_doc_url:function(t){var e=t.type,n=t.name;return"other"==e||"element"==e&&n.startsWith("mml:")&&"mml:math"!=n?null:t.diagram.tag_doc_base+("attribute"==e?"attr-":"elem-")+n.replace(":","_")},min_canvas_width:800,min_canvas_height:400,group_separation:1.4,duration:500,event_handler:null},t.prototype.initialize=function(){var e,r,a=this,i=a.constructor_opts;if("object"==typeof i.container?(r=i.container,e=r.getAttribute("id")):(e=i.container||"dtd-diagram",r=document.getElementById(e)),!r)return void console.error("DtdDiagram error: no container element with ID "+container+" was found");a.container_id=e,t.diagrams_hash[e]=a,a.container_dom=r;var o=a.container_d3=d3.select(r),s=a.get_initial_state();console.log("initial state: %o",s);var d=r.getAttribute("data-options"),c=d?JSON.parse(d):{};t.extend(a,t.default_options,c,s,i);var _=a.min_canvas_width,l=a.min_canvas_height;o.style({width:_+n+"px",height:l+n+"px"});var u=a.svg=o.append("svg"),h=u.append("defs");h.append("defs").html('<filter id="dropshadow" height="130%"><feGaussianBlur in="SourceAlpha" stdDeviation="3"/><feOffset dx="2" dy="2" result="offsetblur"/><feComponentTransfer>  <feFuncA type="linear" slope=".5"/></feComponentTransfer><feMerge>  <feMergeNode/>  <feMergeNode in="SourceGraphic"/></feMerge></filter>'),h.append("defs").html('<linearGradient id="collapsed-linear-gradient">  <stop style="stop-color:#787878;stop-opacity:0.39215687;"        offset="0"/>  <stop style="stop-color:#000000;stop-opacity:0;"        offset="1"/></linearGradient><radialGradient   xlink:href="#collapsed-linear-gradient"   id="collapsed-fill"   gradientUnits="userSpaceOnUse"   gradientTransform="matrix(0.71138316,-0.67243129,1.0234543,1.0827397,-6.6025303,4.7069303)"   cx="10.3125"   cy="9.359375"   fx="10.3125"   fy="9.359375"   r="7.5" />'),h.append("defs").html('<linearGradient id="expanded-linear-gradient">  <stop style="stop-color:#787878;stop-opacity:0.58823532;"        offset="0"/>  <stop style="stop-color:#000000;stop-opacity:0;"        offset="1"/></linearGradient><radialGradient   xlink:href="#expanded-linear-gradient"   id="expanded-fill"   gradientUnits="userSpaceOnUse"   gradientTransform="matrix(0.60291662,-0.63555279,0.73595623,0.69816422,-4.6918189,8.0214032)"   cx="12.196308"   cy="3.283603"   fx="12.196308"   fy="3.283603"   r="7.5" />'),h.append("defs").html('<linearGradient id="hover-linear-gradient">  <stop style="stop-color:#ffffff;stop-opacity:0.58823532;"        offset="0"/>  <stop style="stop-color:#000000;stop-opacity:0;"        offset="1"/></linearGradient><radialGradient    xlink:href="#hover-linear-gradient"   id="hover-gradient"   gradientUnits="userSpaceOnUse"   gradientTransform="matrix(0.98751557,-0.85565774,1.0673114,1.2317852,-10.470545,8.953672)"   cx="12.196308"   cy="3.283603"   fx="12.196308"   fy="3.283603"   r="7.5" />');var p=a.canvas=new t.Box(-l/2,0,l/2,_);u.attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",width:p.width(),height:p.height()}),a.svg_g=u.append("g").attr({transform:"translate(0, "+-p.top+")"});a.engine=d3.layout.flextree().nodeSize(function(e){return[t.Node.node_height,e.y_size()]}).separation(function(t,e){var n=t.elem_parent==e.elem_parent?1:a.group_separation;return n}),a.diagonal=d3.svg.diagonal().source(function(t,e){var n=t.source;t.target;return{x:n.x+(n.has_content()&&"attribute"==t.target.type?-6:n.has_attributes()&&"attribute"!=t.target.type?6:0),y:n.y+n.width()}}).projection(function(t){return[t.y,t.x]});return new Promise(function(t,e){var n=a.dtd_json_file;d3.json(n,function(r,i){if(r)e(new Error("Error reading DTD file '"+n+"': "+r.statusText));else{a.dtd_json=i;try{a.make_tree(),t()}catch(o){e(o)}}})})},t.prototype.make_tree=function(){var e=this,n=e.orig_root_name;if(n){if(!e.dtd_json.elements[n])throw e.orig_root_name=null,new Error("Can't find a declaration for element "+n+" in the DTD.")}else n=e.orig_root_name=e.dtd_json.root;e.orig_root_node=t.Node.factory(e,{name:n,type:"element"},null,"0");e.current_root_addr||(e.current_root_addr="0"),e.set_current_root(),e.set_ec_state(),e.set_src_node(),e.update_state()};var r=t.transition_promise=function(t){var e=0;return new Promise(function(n,r){t.empty()?n():t.each(function(){++e}).each("end",function(){--e||n()})})};t.prototype.rebase=function(t){var e=this;e.set_current_root(t),t.redraw=!0,t.q=null,this.update(t,!0)},t.prototype.update=function(e,n){var a=this;e&&a.set_src_node(e),e=a.src_node,"undefined"!=typeof n&&n&&a.push_state();var i=[],o=a.engine,s=o.nodes(a.current_root_node);t.Node.start_update(a,s),a.nodes_enter.each(function(t){t.draw_enter(this)}),a.nodes_update.each(function(t){i.push(t.transition_update())}),a.nodes_exit.each(function(t){i.push(t.transition_exit())});var d=o.links(s),c=a.svg_g.selectAll("path.link").data(d,function(t){return t.target.id}),_={x:e.x0,y:e.y0,width:function(){return 0},has_content:function(){return!1},has_attributes:function(){return!1}},l=a.diagonal;c.enter().insert("path","g").attr("class","link").attr("d",function(t){return l({source:_,target:_})});var u=a.duration;i.push(r(c.transition().duration(u).attr("d",l))),i.push(r(c.exit().transition().duration(u).attr("d",function(t){return l({source:_,target:_})}).remove()));var h=t.Canvas;i.push(t.Canvas.scroll_resize(a)),a.canvas=a.new_canvas.copy(),Promise.all(i).then(function(t){h.finish(a)},function(t){console.error("Problem during transistions: "+t.stack)}),s.forEach(function(t){t.x0=t.x,t.y0=t.y})},t.extend=function(){for(var t=arguments[0],e=1;e<arguments.length;++e){var n=arguments[e];for(var r in n)n.hasOwnProperty(r)&&(t[r]=n[r])}return t}}(),function(){var t=DtdDiagram.Box=function(t,e,n,r){this.top=t,this.left=e,this.bottom=n,this.right=r};DtdDiagram.extend(t.prototype,{log:function(t){console.log(t+": {top: "+this.top+", left: "+this.left+", bottom: "+this.bottom+", right: "+this.right+"}")},copy:function(){return new t(this.top,this.left,this.bottom,this.right)},width:function(){return this.right-this.left},height:function(){return this.bottom-this.top},vcenter:function(){return(this.top+this.bottom)/2},vmove:function(t){return this.top+=t,this.bottom+=t,this},hmove:function(t){return this.left+=t,this.right+=t,this}})}(),function(){function t(e,n){var r=n.get_children().reduce(t,e),a=n.extents();return new DtdDiagram.Box(d3.min([r.top,a.top]),d3.min([r.left,a.left]),d3.max([r.bottom,a.bottom]),d3.max([r.right,a.right]))}var e=DtdDiagram.Node={node_height:32,node_box_height:25,diagonal_width:20,node_text_margin:10},n={};e.register=function(t,e){n[t]=e},e.factory=function(t,e,r,a){if(!e.type)return console.error("Invalid DTD, every node specifier must have a type"),null;var i=n[e.type];if(!i)return console.error("Invalid DTD, node type not recognized: "+e.type),null;var o=new i;o.id=a,o.x0=r?r.x0:0,o.y0=r?r.y0:0,o.diagram=t,o.spec=e,o.elem_parent=r,o.children=[];for(var s in e)"children"!=s&&(o[s]=e[s]);return o.initialize(),"undefined"==typeof t.nodes&&(t.nodes={}),t.nodes[a]=o,o},e.path=function(){for(var t="",e=0;e<arguments.length;++e)t+=arguments[e]+" ";return t},e.la=function(t,e){return"l "+t*Math.cos(e)+","+t*Math.sin(e)+" "},e.arc=function(t,e,n,r){return"undefined"==typeof r&&(r=0),"a "+t+","+t+" 0,"+r+",1 "+e+","+n+" "},e.start_update=function(t,e){var n=t.src_node,r=t.nodes_update=t.svg_g.selectAll("g.node").data(e,function(t){return t.id}),a=t.nodes_enter=r.enter().append("g").attr({"class":function(t){return"node "+t.type},filter:"url(#dropshadow)",transform:"translate("+n.y0+","+n.x0+") scale(0.001, 0.001)"});a.each(function(t){t.gs=d3.select(this)}),t.nodes_exit=r.exit()},e.methods={initialize:function(){},has_content:function(){return!1},has_attributes:function(){return!1},has_q:function(){return!1},q_width:function(){return 0},get_children:function(){return this.children||[]},get_child:function(t){return this.get_children()[t]},get_content:function(){return[]},element_list:function(){return this.get_children().reduce(function(t,e){return t.concat(e.element_list())},"element"==this.type?[this]:[])},state:function(){return""+this.state_children()},state_children:function(){return this.get_children().reduce(function(t,e){return t+e.state()},"")},set_ec_state:function(t,e){return this.set_state_children(t,e)},set_state_children:function(t,e){for(var n=this.get_children(),r=0;r<n.length;++r)e=n[r].set_ec_state(t,e);return e},extents:function(){this.diagram;return new DtdDiagram.Box(this.x-e.node_box_height/2,this.y,this.x+e.node_box_height/2,this.y+this.width())},tree_extents:function(){return this.get_children().reduce(t,this.extents())},y_size:function(){return this.width()+e.diagonal_width},width:function(){return this.compute_width()},transition_update:function(){var t=this;return DtdDiagram.transition_promise(t.gs.transition().duration(t.diagram.duration).attr("transform","translate("+t.y+","+t.x+") scale(1, 1)"))},transition_exit:function(){var t=this;return src_node=t.diagram.src_node,DtdDiagram.transition_promise(t.gs.transition().duration(t.diagram.duration).attr("transform",function(t){return"translate("+src_node.y+","+src_node.x+") scale(0.001, 0.001)"}).remove())}}}(),function(){var t=DtdDiagram.Node;DtdDiagram.HasLabelNode={draw_enter_label:function(){var e=this,n=e.diagram,r=n.tag_doc_url(e),a=e.gs;r&&(a=e.gs.append("a").attr("xlink:href",r)),a.append("text").attr({id:e.id,"class":"label",x:t.node_text_margin+e.q_width(),y:0,"text-anchor":"baseline","alignment-baseline":"middle"}).text(e.name)},label_width:function(){var e=this,n=e.diagram,r=e.name;"label_width_cache"in n||(n.label_width_cache={});var a=n.label_width_cache;if(!(r in a)){var i=n.svg_g.append("text").attr({id:"temporary-label","class":"label",x:0,y:0}).text(r).style("fill-opacity",0);a[r]=2*t.node_text_margin+document.getElementById("temporary-label").getBBox().width,i.remove()}return a[r]},compute_width:function(){return this.label_width()}}}(),function(){var t=DtdDiagram.Node,e=t.path,n=t.arc,r=t.la,a=(t.arca,12),i=4,o=e("M",-i,0,"l",2*i,0,"M",0,-i,"l",0,2*i),s=4.5,d=function(){for(var t=-Math.PI/2,n="",a=0;5>a;++a)n+=e("M",0,0)+r(s,t+2*a*Math.PI/5);return n}(),c=2.3,_=Math.PI/3,l=-c*Math.sin(_),u=-c*(1+Math.cos(_)),h=2,p=e("M",l,u)+n(c,-l,-u,1)+e("l",0,h)+"m 0,3 "+n(.5,1e-4,0,1)+"z";DtdDiagram.HasQNode={initialize:function(){"q"in this||(this.q=null)},has_q:function(){return!!this.q},q_width:function(){return this.has_q()?a:0},draw_enter_q:function(t){var e=this;if(e.has_q()){var n=e.q,r="*"==n?d:"+"==n?o:p;e.gs.append("g").attr("transform","translate("+t+",0)").append("path").attr({"class":"q",d:r})}}}}(),function(){var t=DtdDiagram.Node,e=DtdDiagram.HasLabelNode,n=DtdDiagram.HasQNode,r=15,a=DtdDiagram.ElementNode=function(){};t.register("element",a),a.content_click_handler=function(t){t.toggle_content(),t.diagram.update(t,!0),"function"==typeof t.diagram.event_handler&&t.diagram.event_handler("content-click",t)},a.attributes_click_handler=function(t){t.toggle_attributes(),t.diagram.update(t,!0),"function"==typeof t.diagram.event_handler&&t.diagram.event_handler("attributes-click",t)},a.rebase_click_handler=function(t){t.content_expanded||t.attributes_expanded||t.expand_content(),t.diagram.rebase(t),"function"==typeof t.diagram.event_handler&&t.diagram.event_handler("rebase",t)},DtdDiagram.extend(a.prototype,t.methods,e,n,{initialize:function(){var e=this,r=e.diagram;n.initialize.call(e),e.content=null,e.content_expanded=!1,e.attributes_expanded=!1;var a=e.declaration=r.dtd_json.elements[e.name];"object"!=typeof a&&(console.error("Can't find a declaration for element "+e.name+" in the DTD."),a=e.declaration=null);var i=e.attributes=[],o=0;a&&a.attributes&&a.attributes.forEach(function(n){i.push(t.factory(r,n,e,e.id+","+o++))})},init_content:function(){var e=this,n=e.diagram,r=e.declaration,a=e.content=[],i=e.attributes.length;r&&r.content&&r.content.children&&r.content.children.forEach(function(r){a.push(t.factory(n,r,e,e.id+","+i++))})},get_content:function(){return null==this.content&&this.init_content(),this.content},has_content:function(){return null==this.content&&this.init_content(),this.content.length>0},has_attributes:function(){return this.attributes.length>0},toggle_content:function(){this.content_expanded=!this.content_expanded,this.set_children()},collapse_content:function(){this.content_expanded=!1,this.set_children()},expand_content:function(){this.content_expanded=!0,this.set_children()},toggle_attributes:function(){this.attributes_expanded=!this.attributes_expanded,this.set_children()},collapse_attributes:function(){this.attributes_expanded=!1,this.set_children()},expand_attributes:function(){this.attributes_expanded=!0,this.set_children()},expand:function(){this.content_expanded=this.attributes_expanded=!0,this.set_children()},set_children:function(){var t=this.content_expanded,e=this.attributes_expanded;t||e?!t&&e?this.children=this.attributes:t&&!e?this.children=this.get_content():this.children=this.attributes.concat(this.get_content()):this.children=[],this.gs&&(this.gs.select(".cb rect").attr("class",t?"expanded":"collapsed"),this.gs.select(".ab rect").attr("class",e?"expanded":"collapsed"))},get_child:function(t){var e=this.attributes.length;return e>t?this.attributes[t]:this.get_content()[t-e]},compute_width:function(){return this.q_width()+(this.has_content()||this.has_attributes()?r:0)+this.label_width()},draw_enter:function(){var e=this,n=(e.diagram,e.gs),r=t.node_box_height;n.append("rect").attr({"data-id":e.id,"class":"box",width:e.width(),height:r,y:-r/2,rx:6,ry:6}),e.draw_enter_label(),e.draw_enter_q(t.node_text_margin),e.has_content()&&e.draw_button("cb",e.has_attributes()?r/4-.5:0,a.content_click_handler),e.has_attributes()&&e.draw_button("ab",e.has_content()?-r/4+.5:0,a.attributes_click_handler);var i=n.append("g").attr({"class":"button rebase",transform:"translate(2, -16)"});i.append("rect").attr({"class":"collapsed",width:10,height:5,x:0,y:0,rx:2.5,ry:2.5,transform:"translate(0,5)"}).on("click",a.rebase_click_handler)},draw_button:function(e,n,a){var i=this,o=(i.diagram,i.gs),s=t.node_box_height,d=i.width(),c=o.append("g").attr({"class":"button "+e,transform:"translate("+(d-r-2)+","+(n+s/4-16.2)+")"}),_="cb"==e?i.content_expanded:i.attributes_expanded,l=_?"expanded":"collapsed";c.append("rect").attr({"class":l,width:15,height:10,x:0,y:0,rx:5,ry:5,transform:"translate(0,5)"}).on("click",a),"cb"==e?c.append("g").attr("transform","translate(-0.56249982,0)").attr("pointer-events","none").html('<g transform="matrix(0.93056698,0,0,1.2232143,-0.79346636,-1.1542969)">  <path d="m 2.5245,8.71325 6.076,-2.842 0,1.022 -4.97,2.268 4.956,2.268 0.014,1.022 -6.076,-2.842 0,-0.896" /></g><g transform="matrix(-0.93056698,0,0,1.2232143,16.918466,-1.1542969)">  <path d="m 2.5245,8.71325 6.076,-2.842 0,1.022 -4.97,2.268 4.956,2.268 0.014,1.022 -6.076,-2.842 0,-0.896"/></g>'):c.append("path").attr("pointer-events","none").attr("d","m 8.136125,11.77975 c -5.6e-6,-0.07466 0.00466,-0.139997 0.014,-0.196 -0.3546719,0.550669 -0.9006713,0.826002 -1.638,0.826 -0.4480035,2e-6 -0.8120031,-0.149331 -1.092,-0.448 -0.2706692,-0.307997 -0.4060024,-0.704663 -0.406,-1.19 -2.4e-6,-0.8493287 0.3079973,-1.5959946 0.924,-2.24 0.615996,-0.6533266 1.3299953,-0.979993 2.142,-0.98 0.186661,7e-6 0.3919941,0.028007 0.616,0.084 l 0.28,0.07 c 0.037327,0.018674 0.083994,0.028007 0.14,0.028 0.04666,6.9e-6 0.1259933,-0.023326 0.238,-0.07 0.1493264,-0.065326 0.2566596,-0.097993 0.322,-0.098 0.1399928,7e-6 0.2099927,0.060674 0.21,0.182 -7.3e-6,0.028007 -0.00934,0.07934 -0.028,0.154 l -0.07,0.266 -0.798,2.982 c -0.028006,0.112003 -0.042006,0.20067 -0.042,0.266 -6.4e-6,0.168003 0.08866,0.252003 0.266,0.252 0.3453264,3e-6 0.667326,-0.223997 0.966,-0.672 0.419992,-0.625329 0.629992,-1.3486617 0.63,-2.17 -8e-6,-0.7746601 -0.256675,-1.4186595 -0.77,-1.932 -0.504007,-0.5133251 -1.1433397,-0.7699915 -1.918,-0.77 -1.0920045,8.5e-6 -2.0440035,0.4386747 -2.856,1.316 -0.8026686,0.8680063 -1.2040015,1.8900053 -1.204,3.066 -1.5e-6,0.91467 0.2939982,1.680002 0.882,2.296 0.587997,0.606668 1.3253296,0.910001 2.212,0.91 0.5226616,10e-7 0.9519945,-0.06067 1.288,-0.182 0.3453271,-0.130665 0.77466,-0.382665 1.288,-0.756 0.1866593,-0.139998 0.340659,-0.209998 0.462,-0.21 0.177326,2e-6 0.265992,0.084 0.266,0.252 -8e-6,0.177335 -0.121341,0.359335 -0.364,0.546 -0.9240066,0.728001 -1.9413389,1.092 -3.052,1.092 -1.1293367,0 -2.0720024,-0.373333 -2.828,-1.12 -0.7466676,-0.755998 -1.1200005,-1.698664 -1.12,-2.828 -5e-7,-1.3626612 0.503999,-2.5479934 1.512,-3.556 1.0173303,-1.0173247 2.2166624,-1.5259908 3.598,-1.526 1.0453267,9.2e-6 1.894659,0.3080089 2.548,0.924 0.662658,0.6160076 0.993991,1.4186735 0.994,2.408 -9e-6,1.1106714 -0.406009,2.081337 -1.218,2.912 -0.494674,0.504002 -1.0126736,0.756002 -1.554,0.756 -0.2426728,2e-6 -0.4433393,-0.06066 -0.602,-0.182 -0.1586723,-0.121331 -0.2380056,-0.275331 -0.238,-0.462 m 0.294,-1.904 0.378,-1.4 c -0.2800059,-0.1399937 -0.5506723,-0.2099937 -0.812,-0.21 -0.5413382,6.3e-6 -1.0173377,0.2380061 -1.428,0.714 -0.4013369,0.4760051 -0.6020034,1.031338 -0.602,1.666 -3.4e-6,0.644003 0.2799963,0.966003 0.84,0.966 0.7746617,3e-6 1.3159945,-0.578663 1.624,-1.736")},transition_update:function(){this.redraw&&(this.gs.html(""),this.draw_enter(),this.redraw=!1),t.methods.transition_update.call(this)},state:function(){return(this.attributes_expanded?"1":"0")+(this.content_expanded?"1":"0")+this.state_children()},set_ec_state:function(t,e){return"undefined"==typeof e&&(e=0),this.attributes_expanded="1"==t.charAt(e),this.content_expanded="1"==t.charAt(e+1),this.set_children(),this.set_state_children(t,e+2)}})}(),function(){var t=DtdDiagram.Node,e=21,n=DtdDiagram.AttributeNode=function(){};t.register("attribute",n),DtdDiagram.extend(n.prototype,t.methods,DtdDiagram.HasLabelNode,{draw_enter:function(){var t=this;t.gs.append("ellipse").attr({"data-id":t.id,"class":"box",cx:t.width()/2,cy:0,rx:t.width()/2,ry:e/2}),t.draw_enter_label()}})}(),function(){DtdDiagram.ChoiceSeqNode={initialize:function(){var t=this;DtdDiagram.HasQNode.initialize.call(t);var e=0;(t.spec.children||[]).forEach(function(n){t.children.push(DtdDiagram.Node.factory(t.diagram,n,t.elem_parent,t.id+","+e++))})},get_content:function(){return this.get_children()},draw_enter:function(){this.gs.append("path").attr({"class":this.type,d:this.path()}),this.draw_enter_q(this.width()/2)}}}(),function(){var t=DtdDiagram.Node,e=20,n=DtdDiagram.ChoiceNode=function(){};t.register("choice",n),DtdDiagram.extend(n.prototype,t.methods,DtdDiagram.HasQNode,DtdDiagram.ChoiceSeqNode,{width:function(){return e},path:function(){return t.path("M",0,0,"L",e/2,-e/2,"L",e,0,"L",e/2,e/2,"z")}})}(),function(){var t=DtdDiagram.Node,e=13,n=DtdDiagram.SeqNode=function(){};t.register("seq",n),DtdDiagram.extend(n.prototype,t.methods,DtdDiagram.HasQNode,DtdDiagram.ChoiceSeqNode,{width:function(){return e},path:function(){var n=t.path;return arc=t.arc,s=8,n("M",0,s/2,"v",-s)+arc(e/2,e,0)+n("v",s)+arc(e/2,-e,0)+"z"}})}(),function(){var t=DtdDiagram.Node,e=18,n=DtdDiagram.OtherNode=function(){};t.register("other",n),DtdDiagram.extend(n.prototype,t.methods,DtdDiagram.HasLabelNode,{draw_enter:function(){var t=this;t.gs.append("g").attr("transform","skewX(-15)").append("rect").attr({"data-id":t.id,"class":"box",width:t.width(),height:e,y:-e/2,rx:3,ry:3}),t.draw_enter_label()}})}(),function(){function t(t){var e=t.container_dom,n=t.new_canvas,r=n.width(),a=n.height();t.svg.style({width:r,height:a}),e.style.display="none",e.style.display="block"}function e(t,e){return function(){var n=d3.interpolateNumber(this.scrollTop,t),r=d3.interpolateNumber(this.scrollLeft,e);return function(t){this.scrollTop=n(t),this.scrollLeft=r(t)}}}function n(n){var r=n.new_viewport,a=n.container_dom;return n.embiggenning&&t(n),new_scroll_top=r.top-n.new_canvas.top,new_scroll_left=r.left,new Promise(function(t,r){a.scrollTop!=new_scroll_top||a.scrollLeft!=new_scroll_left?n.container_d3.transition().duration(n.duration).tween("uniquetweenname1",e(new_scroll_top,new_scroll_left)).each("end",function(){t("done scroll_canvas to "+new_scroll_top+", "+new_scroll_left)}):t("scroll_canvas: nothing to do")})}var r=DtdDiagram.Canvas={dropshadow_margin:5};r.scroll_resize=function(t){return a(t),Promise.all([n(t),new Promise(function(e,n){t.svg_g.transition().duration(t.duration).attr({transform:"translate(0, "+-t.new_canvas.top+")"}).each("end",function(){e("done transitioning svg coordinates")})})])},r.finish=function(e){e.embiggenning||t(e)};var a=function(t){var e=DtdDiagram.Box,n=t.min_canvas_height,a=t.min_canvas_width,i=t.src_node,o=t.canvas,s=t.new_drawing=t.current_root_node.tree_extents();s.bottom+=r.dropshadow_margin;var d=s.height()>=n?s.top:(s.bottom+s.top-n)/2,c=s.height()>=n?s.bottom:d+n,_=t.new_canvas=new e(d,s.left,c,s.width()>=a?s.right:s.left+a),l=i.extents(),u=i.tree_extents(),h=u.copy();if(h.width()>a&&(h.right=h.left+a),h.height()>n){var p=h.vcenter(),f=p-n/2,g=p+n/2,m=l.top<f?l.top-f:l.bottom>g?l.bottom-g:0;h.top=f+m,h.bottom=g+m}var v=t.container_dom,b=v.scrollTop,y=v.scrollLeft,D=t.viewport=new e(b+o.top,y,b+o.top+n,y+a),w=t.new_viewport=D.copy();w.vmove(h.top<w.top?h.top-w.top:h.bottom>w.bottom?h.bottom-w.bottom:0),w.vmove(_.top>w.top?_.top-w.top:_.bottom<w.bottom?_.bottom-w.bottom:0),w.hmove(h.left<w.left?h.left-w.left:h.right>w.right?h.right-w.right:0),w.hmove(_.left>w.left?_.left-w.left:_.right<w.right?_.right-w.right:0),t.embiggenning=_.width()>o.width()||_.height()>o.height()}}(),"undefined"==typeof DtdDiagram&&(DtdDiagram=function(){}),function(){var t=!1,e=t&&"undefined"!=typeof window&&window.console?console.log.bind(window.console):function(){},n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-.",r=DtdDiagram.Compressor={compress:function(t){e("compressing original string: "+t);var n=r.rll_compress(t);e("rll_compressed: "+n);var a=r.binstr_to_base64(n);return e("base64: "+a),e("compression ratio: "+t.length/a.length),a},binstr_to_base64:function(t){for(var e=r.cap(t),a=e.length,i="",o=0;a>o;o+=6){var s=parseInt(e.substr(o,6),2);i+=n.charAt(s)}return i},cap:function(t){var n=t+"1"+"0".repeat(5-t.length%6);return e("capped: "+n),n},int_to_binary:function(t,e){var n=t.toString(2);return"0".repeat(e-n.length)+n},rll_compress:function(t){var e=t.indexOf("1"),n=-1==e?"":(0==e?"00":4>=e?"01"+r.int_to_binary(e-1,2):20>=e?"10"+r.int_to_binary(e-5,4):"11"+r.int_to_binary(e-21,10))+r.rll_compress(t.substr(e+1));return n},decompress:function(t){e("decompressing: "+t);var n=r.base64_to_binstr(t);e("rll_compressed: "+n);var a=r.rll_decompress(n);return e("final binary string: "+a),a},base64_to_binstr:function(t){var r=t.split("").reduce(function(t,e){var r=n.indexOf(e).toString(2);return r="0".repeat(6-r.length)+r,t+r},"");e("  capped: "+r);var a=r.substr(0,r.lastIndexOf("1"));return e("  uncapped: "+a),a},rll_decompress:function(t){for(var e="";t.length>0;){var n,r=t.substr(0,2);"00"==r?(n=0,t=t.substr(2)):"01"==r?(n=parseInt(t.substr(2,2),2)+1,t=t.substr(4)):"10"==r?(n=parseInt(t.substr(2,4),2)+5,t=t.substr(6)):(n=parseInt(t.substr(2,10),2)+21,t=t.substr(12)),e+="0".repeat(n)+"1"}return e}};"undefined"!=typeof module&&(module.exports=r)}(),"undefined"==typeof DtdDiagram&&(DtdDiagram=function(){}),function(){function t(t,e){return e.substr(t.length+1)}function e(e,n,r){for(var a,i=t(n.id,r),o=i.split(","),s=n;"undefined"!=typeof(nistr=o.shift());){var a=parseInt(nistr);s=s.get_child(a)}return s}"undefined"!=typeof window&&(window.onpopstate=function(t){console.log("popstate: %o",t.state);var e=t.state;Object.keys(e).forEach(function(t){var n=DtdDiagram.diagrams_hash[t];if(n){console.log("popping for "+t);var r=e[t];n.set_current_root(r.current_root_addr),n.set_ec_state(r.ec_state),n.state_id<r.state_id?(n.set_src_node(r.src_node_addr),n.update()):(n.update(),n.set_src_node(r.src_node_addr)),n.state_id=r.state_id}})}),DtdDiagram.last_state_id=0,DtdDiagram.prototype.get_initial_state=function(){var t=this;if(history.state)return history.state[t.container_id]||null;var e=t.get_url_state();return e?{orig_root_name:e.root_name,current_root_addr:"0",ec_state:e.ec_state,src_node_addr:e.src_node_addr}:null},DtdDiagram.prototype.get_url_state=function(){var t=this,e=window.location.search;if(e&&"?"==e.charAt(0)){var n=null;return e.substr(1).split("&").forEach(function(e){var r=e.split("=");if(2==r.length&&r[0]==t.container_id){n={};var a=r[1].split("!");n={root_name:a[0],ec_state:a.length>1?a[1]:null,src_node_addr:a.length>2?a[2]:null}}}),n}},DtdDiagram.prototype.update_state=function(){var t=this,e=history.state||{},n=DtdDiagram.last_state_id++;t.state_id=n,e[t.container_id]={orig_root_name:t.orig_root_name,current_root_addr:t.current_root_addr,ec_state:t.ec_state,src_node_addr:t.src_node_addr,state_id:n},history.replaceState(e,null)},DtdDiagram.prototype.push_state=function(){var t=this,e={},n=DtdDiagram.last_state_id++;t.state_id=n,e[t.container_id]={orig_root_name:t.orig_root_name,current_root_addr:t.current_root_addr,ec_state:t.get_ec_state(),src_node_addr:t.src_node_addr,state_id:n};var r=DtdDiagram.extend({},history.state,e),a=!0,i="";Object.keys(r).forEach(function(t){var e=r[t],n=DtdDiagram.diagrams_hash[t];n&&e&&e.orig_root_name&&(i+=(a?"?":"&")+t+"="+n.current_root_node.name+"!"+e.ec_state+"!"+e.src_node_addr),a=!1}),history.pushState(r,null,i)},DtdDiagram.prototype.set_current_root=function(t){var n=this;"object"==typeof t?(n.current_root_node=t,n.current_root_addr=t.id):("undefined"==typeof t&&(t=n.current_root_addr),"undefined"==typeof n.nodes[t]&&e(n,n.orig_root_node,t),n.current_root_node=n.nodes[t])},DtdDiagram.prototype.get_ec_state=function(){var t=this.current_root_node.state();return this.ec_state=DtdDiagram.Compressor.compress(t)},DtdDiagram.prototype.set_ec_state=function(t){"undefined"!=typeof t&&(this.ec_state=t);var e=DtdDiagram.Compressor.decompress(this.ec_state);this.current_root_node.set_ec_state(e)},DtdDiagram.prototype.set_src_node=function(n){var r=this;if("object"==typeof n)r.src_node=n,r.src_node_addr=t(r.current_root_addr,n.id);else{"undefined"==typeof n&&(n=r.src_node_addr);var a=r.current_root_addr+(""==n?"":","+n);"undefined"==typeof r.nodes[a]&&e(r,r.current_root_node,a),r.src_node=r.nodes[a]}}}();
//# sourceMappingURL=dtd-diagram.min.js.map
